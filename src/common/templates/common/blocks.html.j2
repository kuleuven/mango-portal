{% macro permission_block(item_path, permissions, acl_users_dict, acl_counts, my_groups=[], group_filter_exclude=[], recursive=false )%}
    <table class="table table-striped table-hover mt-2" id="permssions-table">
        <thead>
            <tr>
                {# <th scope="col">Select</th> #}
                <th scope="col">User / Group</th>
                <th scope="col">Access level</th>
                <th scope="col">Zone</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for permission in permissions %}
                <tr>
                    <td>{{ permission.user_name }} ({{ acl_users_dict[permission.user_name] }})</td>
                    <td>{{ permission.access_name }}</td>
                    <td>{{ permission.user_zone }}</td>
                    <td>
                        {% if config['ACL_PROTECT_OWN'] and permission.access_name == 'own' and acl_counts['own'] < 2 %}
                            <p title="disabled: need at least 1 owner">
                                <button type="submit"
                                        class="btn btn-grey"
                                        disabled
                                        title="At least one owner required">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </p>
                        {% else %}
                            <form method="post"
                                  action="{{ url_for('browse_bp.set_permissions', item_path=item_path) }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                <input type="hidden" name="groups" value="{{ permission.user_name }}" />
                                <input type="hidden" name="permission_type" value="null" />
                                <input type="hidden" name="redirect_hash" value="#permissions"/>
                                <button type="submit" class="btn">
                                    <i class="bi bi-trash text-danger"></i>
                                </button>
                            </form>
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    <form method="post"
          action="{{ url_for('browse_bp.set_permissions', item_path=item_path) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <input type="hidden" name="redirect_hash" value="#permissions"/>
        <div class="row">
            <div class="col">
                <label for="permission_groups">Groups</label>
                <select class="form-select"
                        aria-label="Groups"
                        name="groups"
                        id="permission_groups">
                    {% for group in my_groups %}
                        <option value="{{ group.name }}">
                            {{ group.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col">
                <label for="permission_type">Rights</label>
                <select class="form-select"
                        aria-label="Groups"
                        name="permission_type"
                        id="permission_type">
                    <option value="own">
                        Own
                    </option>
                    <option value="write">
                        Modify
                    </option>
                    <option value="read">
                        Read
                    </option>
                </select>
            </div>
            {% if recursive %}
                <div class="col">
                    <input type="checkbox" name="recursive" id="set_recursive" value="True"/>
                    <label for="set_recursive">Recursive</label>
                </div>
            {% endif %}
            <div class="col">
                <button type="submit" class="btn btn-primary">Apply</button>
            </div>
        </div>
    </form>
{% endmacro %}
{% macro metadata_block(object_path, grouped_metadata, metadata_schema_filenames, schema_labels, readonly_prefixes=('mt.', 'mg.', 'irods::')) %}
    {% if grouped_metadata|length == 1 and 'other' in grouped_metadata %}
        <table class="table table-striped table-hover mt-2">
            <tbody>
                {% for item in grouped_metadata['other'].items() %}
                    <tr>
                        <th>{{ item.name }}</th>
                        <td>{{ item.value }}</td>
                        <td>{{ item.units if item.units is not none }}</td>
                        {% if not item.name.startswith(readonly_prefixes) %}
                            <td>
                                <a href="#"
                                   data-bs-toggle="modal"
                                   data-bs-target="#editMetaData"
                                   data-bs-meta-data-name="{{ item.name }}"
                                   data-bs-meta-data-value="{{ item.value }}"
                                   data-bs-meta-data-units="{{ item.units if item.units is not none }}"
                                   data-bs-object-path="{{ object_path }}"><i class="bi bi-pencil"></i></a>
                            </td>
                            <td>
                                <a href="#"
                                   data-bs-toggle="modal"
                                   data-bs-target="#deleteMetaData"
                                   class="text-danger"
                                   data-bs-meta-data-name="{{ item.name }}"
                                   data-bs-meta-data-value="{{ item.value }}"
                                   data-bs-meta-data-units="{{ item.units if item.units is not none }}"
                                   data-bs-object-path="{{ object_path }}"><i class="bi bi-trash"></i></a>
                            </td>
                        {% else %}
                            <td></td>
                            <td></td>
                        {% endif %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        <button type="button"
                class="btn btn-primary"
                data-bs-toggle="modal"
                data-bs-target="#addMetaData">
            Add metadata
        </button>
        <h4 class="mt-4">Edit/add metadata via schema</h4>
        <form class="row g-3 col-md-6 mt-4"
              method="get"
              action="{{ url_for('metadata_schema_form_bp.edit_schema_metadata_for_item')}}">
            <input type="hidden" name="item_type" value="collection" />
            <input type="hidden" name="id" value="{{ collection.id }}" />
            <select name="schema" class="form-select">
                {% for schema_file in metadata_schema_filenames %}
                    <option value="{{ schema_file }}">
                        {{ schema_file[:-5] }}
                    </option>
                {% endfor %}
            </select>
            <button type="submit" class="btn btn-primary">Edit</button>
        </form>
    {% else %}
        <!-- nav top bar -->
        <ul class="nav nav-pills mb-3 mt-3" id="schema-tab" role="tablist">
            {% for schema in grouped_metadata %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if loop.index == 1 %}active{% endif %}"
                            id="pills-{{ schema }}-tab"
                            data-bs-toggle="pill"
                            data-bs-target="#pills-{{ schema }}"
                            type="button"
                            role="tab"
                            aria-controls="pills-{{ schema }}"
                            {% if loop.index == 1 %}aria-selected="true"{% else %}aria-selected="false"{% endif %}>
                        {{ schema }}
                    </button>
                </li>
            {% endfor %}
        </ul>
        <!-- content-->
        <div class="tab-content" id="pills-tabContent-schema">
            {% for schema in grouped_metadata %}
                <div class="tab-pane fade {% if loop.index == 1 %}show active{% endif %}"
                     id="pills-{{ schema }}"
                     role="tabpanel"
                     aria-labelledby="pills-{{ schema }}-tab">
                    <table class="table table-striped table-hover mt-2">
                        <tbody>
                            {% for _key, item in grouped_metadata[schema].items() %}
                                <tr>
                                    <th>
                                        <span title="{{ item.name }}">{{ schema_labels[schema][item.name]['label'] if (schema_labels[schema] and schema_labels[schema][item.name]) else item.name }}</span>
                                    </th>
                                    <td title="Created: {{ item.create_time }} | Modified: {{ item.modify_time }}">{{ item.value }}</td>
                                    <td>{{ item.units if item.units is not none }}</td>
                                    {% if not item.name.startswith(('ku.', 'irods::')) and schema == 'other' %}
                                        <td>
                                            <a href="#"
                                               data-bs-toggle="modal"
                                               data-bs-target="#editMetaData"
                                               data-bs-meta-data-name="{{ item.name }}"
                                               data-bs-meta-data-value="{{ item.value }}"
                                               data-bs-meta-data-units="{{ item.units if item.units is not none }}"
                                               data-bs-object-path="{{ collection.path }}"><i class="bi bi-pencil"></i></a>
                                        </td>
                                        <td>
                                            <a href="#"
                                               data-bs-toggle="modal"
                                               data-bs-target="#deleteMetaData"
                                               class="text-danger"
                                               data-bs-meta-data-name="{{ item.name }}"
                                               data-bs-meta-data-value="{{ item.value }}"
                                               data-bs-meta-data-units="{{ item.units if item.units is not none }}"
                                               data-bs-object-path="{{ collection.path }}"><i class="bi bi-trash"></i></a>
                                        </td>
                                    {% else %}
                                        <td></td>
                                        <td></td>
                                    {% endif %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% if schema == 'other' %}
                        <button type="button"
                                class="btn btn-primary"
                                data-bs-toggle="modal"
                                data-bs-target="#addMetaData">
                            Add metadata
                        </button>
                        <h4 class="mt-4">
                            Edit/add metadata via schema
                        </h4>
                        <form class="row g-3 col-md-6 mt-4"
                              method="get"
                              action="{{ url_for('metadata_schema_form_bp.edit_schema_metadata_for_item')}}">
                            <input type="hidden" name="item_type" value="collection" />
                            <input type="hidden" name="id" value="{{ collection.id }}" />
                            <select name="schema" class="form-select">
                                {% for schema_file in metadata_schema_filenames %}
                                    <option value="{{ schema_file }}">
                                        {{ schema_file[:-5] }}
                                    </option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="btn btn-primary">
                                Edit
                            </button>
                        </form>
                    {% else %}
                        <form class="row g-3 col-md-6 mt-4"
                              method="get"
                              action="{{ url_for('metadata_schema_form_bp.edit_schema_metadata_for_item')}}">
                            <input type="hidden" name="item_type" value="collection" />
                            <input type="hidden" name="id" value="{{ collection.id }}" />
                            <input name="schema" type="hidden" value="{{ schema }}.json" />
                            <button type="submit" class="btn btn-primary">
                                Edit
                            </button>
                        </form>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% endif %}
{% endmacro %}
{% macro analysis_tika_block(result)%}
    <h2>
        Analysis via Tika
    </h2>
    <ul class="list-group">
        {% if result['X-TIKA:Parsed-By-Full-Set'] is not string %}
            {% for step in result['X-TIKA:Parsed-By-Full-Set'] %}
                <li class="list-group-item">
                    {{ step }}
                </li>
            {% endfor %}
        {% else %}
            <li class="list-group-item">
                {{ result['X-TIKA:Parsed-By-Full-Set'] }}
            </li>
        {% endif %}
    </ul>
    <h3>
        Text content for full text indexing
    </h3>
    <pre>
    {{result['X-TIKA:content']}}
    </pre>
    <h3>
        Metadata fields
    </h3>
    <table class="table">
        {% for key, item in result.items() %}
            {% if key not in ['X-TIKA:content','X-TIKA:Parsed-By-Full-Set', 'X-TIKA:Parsed-By'] %}
                <tr>
                    <th>
                        {{ key }}
                    </th>
                    <td>
                        {{ item }}
                    </td>
                </tr>
            {% endif %}
        {% endfor %}
    </table>
{% endmacro %}
