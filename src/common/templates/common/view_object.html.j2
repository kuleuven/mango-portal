{% extends "base.html.j2" %}
{% import "dialogs.html.j2" as dialogs %}
{% import "blocks.html.j2" as block_macros %}
{% block body %}
  <nav style="--bs-breadcrumb-divider: '>'" aria-label="breadcrumb">
    <ol class="breadcrumb">
      {% for element in breadcrumbs[:-1] %}
        <li class="breadcrumb-item">
          <a href="{{ url_for('browse_bp.collection_browse', collection=element['url'])}}">{{ element['label'] }}</a>
        </li>
      {% endfor %}
      <li class="breadcrumb-item active" aria-current="page">{{ breadcrumbs[-1]['label'] }}</li>
    </ol>
  </nav>
  <div class="row">
    <div class="col-11">
      <h2 class="mb-4">{{ data_object.name }}</h2>
    </div>
    <div class="col-1 display-6">
      {% if data_object.size < 20000000000 %}
        <a href="{{ url_for('browse_bp.download_object', data_object_path = data_object.path)}}"><i class="bi bi-download"></i></a>
      {% endif %}
    </div>
  </div>
  <ul class="nav nav-tabs mb-4" id="object_tab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active"
              id="system-tab"
              data-bs-toggle="tab"
              data-bs-target="#system"
              type="button"
              role="tab"
              aria-controls="home"
              aria-selected="true">
        System properties
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link"
              id="meta-data-tab"
              data-bs-toggle="tab"
              data-bs-target="#meta-data"
              type="button"
              role="tab"
              aria-controls="meta-data"
              aria-selected="false">
        Metadata
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link"
              id="permissions-tab"
              data-bs-toggle="tab"
              data-bs-target="#item-permissions"
              type="button"
              role="tab"
              aria-controls="collection-permissions"
              aria-selected="false">
        Permissions
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link"
              id="preview-tab"
              data-bs-toggle="tab"
              data-bs-target="#preview"
              type="button"
              role="tab"
              aria-controls="preview"
              aria-selected="false">
        Preview
      </button>
    </li>
  </ul>
  <div class="tab-content" id="myTabContent">
    <div class="tab-pane fade show active"
         id="system"
         role="tabpanel"
         aria-labelledby="system-tab">
      <table class="table table-striped table-hover">
        <tr>
          <th>Owner</th>
          <td>{{ data_object.owner_name }}</td>
        </tr>
        <tr>
          <th>Created</th>
          <td>{{ data_object.create_time }}</td>
        </tr>
        <tr>
          <th>Modified</th>
          <td>{{ data_object.modify_time }}</td>
        </tr>
        <tr>
          <th>Size</th>
          <td>{{ data_object.size | filesizeformat }}</td>
        </tr>
        <tr>
          <th>Internal id</th>
          <td>{{ data_object.id }}</td>
        </tr>
        <tr>
          <th>Status</th>
          <td>{{ data_object.status }}</td>
        </tr>
        <tr>
          <th>Replica number</th>
          <td>{{ data_object.replica_number }}</td>
        </tr>
      </table>
      <div class="row mt-5">
        <div class="col">
          <button type="button"
                  class="btn btn-danger float-end"
                  data-bs-toggle="modal"
                  data-bs-target="#delete_object">
            Delete Data Object
          </button>
        </div>
      </div>
      {{ dialogs.confirm_delete_dialog('delete_object', url_for('browse_bp.delete_data_object'), title='Are you sure you want to delete?', mode="listen-many", readonly_fields = [{'name' : 'data_object_path', 'value': data_object.path, 'label': 'Object Path'}], hidden_fields=[{'name':'redirect_route', 'value': url_for('browse_bp.collection_browse', collection=data_object.collection.path)}], modal_class="modal-xl" )}}
    </div>
    <div class="tab-pane fade"
         id="meta-data"
         role="tabpanel"
         aria-labelledby="meta-data-tab">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th scope="col">Name</th>
            <th scope="col">Value</th>
            <th scope="col">Unit</th>
          </tr>
        </thead>
        {% for item in meta_data_items %}
          <tr>
            <th>{{ item.name }}</th>
            <td>
              {{ item.value }}
            </td>
            <td>
              {{ item.units if item.units is not none }}
            </td>
            {% if not item.name.startswith(('irods::', 'mg.', 'mt.')) %}
              <td>
                <a href="#"
                   data-bs-toggle="modal"
                   data-bs-target="#editMetaData"
                   data-bs-meta-data-name="{{ item.name }}"
                   data-bs-meta-data-value="{{ item.value }}"
                   data-bs-meta-data-units="{{ item.units if item.units is not none }}"
                   data-bs-object-path="{{ data_object.path }}"><i class="bi bi-pencil"></i></a>
              </td>
              <td>
                <a href="#"
                   data-bs-toggle="modal"
                   data-bs-target="#deleteMetaData"
                   class="text-danger"
                   data-bs-meta-data-name="{{ item.name }}"
                   data-bs-meta-data-value="{{ item.value }}"
                   data-bs-meta-data-units="{{ item.units if item.units is not none }}"
                   data-bs-object-path="{{ data_object.path }}"><i class="bi bi-trash"></i></a>
              </td>
            {% else %}
              <td>
              </td>
              <td>
              </td>
            {% endif %}
          </tr>
        {% endfor %}
      </table>
      <button type="button"
              class="btn btn-primary"
              data-bs-toggle="modal"
              data-bs-target="#addMetaData">
        Add metadata
      </button>
    </div>
    <div class="tab-pane" id="item-permissions">
      {{ block_macros.permission_block(data_object.path.lstrip("/"), permissions, acl_users_dict, acl_counts, my_groups=my_groups)}}
    </div>
    <div class="tab-pane fade"
         id="preview"
         role="tabpanel"
         aria-labelledby="preview-tab">
      {# to be moved to its own server side handler + template to include #}
      {% if data_object.name.endswith(('jpg','jpeg','png', 'pdf')) %}
        <div class="row">
          <img src="{{ url_for('browse_bp.object_preview', data_object_path = data_object.path)}}"
               class="w-50"
               style="object-fit: contain"
               alt="preview image"/>
        </div>
      {% else %}
        <p>
          Preview not possible for this type
        </p>
      {% endif %}
      <h5 class="mt-4">
        Analysis
      </h5>
      <form class="row row-cols-lg-auto g-3 align-items-center mt-3"
            method="get"
            action="{{ url_for('browse_bp.ask_tika', data_object_path=data_object.path)}}">
        {% if data_object.name.endswith(('.jpg','.jpeg','.png', '.tif', '.tiff', '.gif')) %}
          <div class="col-12">
            <input class="form-check-input"
                   type="checkbox"
                   value="true"
                   id="tika-ocr"
                   name="do-tika-ocr"/>
            <label class="form-check-label" for="tika-ocr">
              Perform OCR on the image to extract text
            </label>
          </div>
        {% endif %}
        <div class="col-12">
          <input class="form-check-input"
                 type="checkbox"
                 value="true"
                 id="tika-skip-cache"
                 name="skip-tika-cache"/>
          <label class="form-check-label" for="tika-skip-cache">
            Skip cache
          </label>
        </div>
        <div class="col-12">
          <button type="submit" class="btn btn-primary">
            Ask Tika
          </button>
        </div>
      </form>
    </div>
    {# temp #}
    {# {% for r in metadata_objects %}
      <p>
        {{ r|pprint }}
      </p>
    {% endfor %} #}
    {# endtemp #}
  </div>
  <!-- edit metadata modal -->
  <div class="modal fade"
       id="editMetaData"
       tabindex="-1"
       aria-labelledby="editMetaDataLabel"
       aria-hidden="true"
       class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editMetaDataLabel">
          Update metadata
        </h5>
        <button type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close">
        </button>
      </div>
      <form action="{{ url_for('metadata_bp.edit_meta_data')}}"
            method="post"
            enctype="multipart/form-data"
            class="row g-3 needs-validation"
            novalidation>
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <div class="modal-body">
          <div class="mb-3">
            <label for="meta-data-name" class="col-form-label">
              Name
            </label>
            <input type="text"
                   class="form-control"
                   id="meta-data-name"
                   name="meta-data-name"
                   required/>
            <div class="invalid-feedback">
              Metadata field name is required
            </div>
          </div>
          <div class="mb-3">
            <label for="meta-data-value" class="col-form-label">
              Value
            </label>
            <input type="text"
                   class="form-control"
                   id="meta-data-value"
                   name="meta-data-value"
                   required/>
            <div class="invalid-feedback">
              Metadata field value is required
            </div>
          </div>
          <div class="mb-3">
            <label for="meta-data-units" class="col-form-label">
              Unit
            </label>
            <input type="text"
                   class="form-control"
                   id="meta-data-units"
                   name="meta-data-units"/>
          </div>
          <input type="hidden"
                 id="object-path-edit"
                 name="object-path"
                 value="{{ data_object.path }}"/>
          <input type="hidden"
                 id="orig-meta-data-name"
                 name="orig-meta-data-name"
                 value=""/>
          <input type="hidden"
                 id="orig-meta-data-value"
                 name="orig-meta-data-value"
                 value=""/>
          <input type="hidden"
                 id="orig-meta-data-units"
                 name="orig-meta-data-units"
                 value=""/>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Cancel
          </button>
          <button class="btn btn-primary" type="submit">
            Update
          </button>
        </div>
      </form>
    </div>
  </div>
  <!-- Add meta data-->
  <div class="modal fade"
       id="addMetaData"
       tabindex="-1"
       aria-labelledby="addMetaDataLabel"
       aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addMetaDataLabel">
            Add metadata
          </h5>
          <button type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close">
          </button>
        </div>
        <form action="{{ url_for('metadata_bp.add_meta_data')}}"
              method="post"
              enctype="multipart/form-data"
              class="row g-3 needs-validation"
              novalidate>
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
          <div class="modal-body">
            <div class="mb-3">
              <label for="meta-data-name-add" class="col-form-label">
                Name
              </label>
              <input type="text"
                     class="form-control"
                     id="meta-data-name-add"
                     name="meta-data-name"
                     required/>
              <div class="invalid-feedback">
                Name is required for metadata items
              </div>
            </div>
            <div class="mb-3">
              <label for="meta-data-value-add" class="col-form-label">
                Value
              </label>
              <input type="text"
                     class="form-control"
                     id="meta-data-value-add"
                     name="meta-data-value"
                     required/>
            </input>
            <div class="invalid-feedback">
              A value is required for metadata items
            </div>
          </div>
          <div class="mb-3">
            <label for="meta-data-units-add" class="col-form-label">
              Unit
            </label>
            <input type="text"
                   class="form-control"
                   id="meta-data-units-add"
                   name="meta-data-units"/>
          </input>
          <div class="valid-feedback">
            A unit is not required for metadata
          </div>
        </div>
        <input type="hidden"
               id="object-path-add"
               name="object-path"
               value="{{ data_object.path }}"/>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button class="btn btn-primary" type="submit">
          Add
        </button>
      </div>
    </form>
  </div>
</div>
</div>
<!-- Delete modal -->
<div class="modal fade"
     id="deleteMetaData"
     tabindex="-1"
     aria-labelledby="deleteMetaDataLabel"
     aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteMetaDataLabel">
          Delete metadata
        </h5>
        <button type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close">
        </button>
      </div>
      <form action="{{ url_for('metadata_bp.delete_meta_data')}}"
            method="post"
            enctype="multipart/form-data"
            class="row g-3 needs-validation"
            novalidation>
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <div class="modal-body">
          <div class="mb-3">
            <label for="meta-data-name-delete" class="col-form-label">
              Name
            </label>
            <input type="text"
                   class="form-control"
                   id="meta-data-name-delete"
                   name="meta-data-name"
                   readonly/>
            <div class="invalid-feedback">
              Metadata field name is required
            </div>
          </div>
          <div class="mb-3">
            <label for="meta-data-value-delete" class="col-form-label">
              Value
            </label>
            <input type="text"
                   class="form-control"
                   id="meta-data-value-delete"
                   name="meta-data-value"
                   readonly/>
            <div class="invalid-feedback">
              Metadata field value is required
            </div>
          </div>
          <div class="mb-3">
            <label for="meta-data-units" class="col-form-label">
              Unit
            </label>
            <input type="text"
                   class="form-control"
                   id="meta-data-units-delete"
                   name="meta-data-units"
                   readonly/>
          </div>
          <input type="hidden"
                 id="object-path-delete"
                 name="object-path"
                 value="{{ data_object.path }}"/>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Cancel
          </button>
          <button class="btn btn-danger" type="submit">
            Delete
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock body %}
{% block javascript %}
  {{ super() }}
  <script async src="{{url_for('static', filename='js/form-validation.js')}}"></script>
  <script>
//// Edit meta data listener for modal
var editMetaData = document.getElementById('editMetaData')
editMetaData.addEventListener('show.bs.modal', function (event) {
  // Button that triggered the modal
  var button = event.relatedTarget
  // Extract info from data-bs-* attributes
  var fieldMDName = button.getAttribute('data-bs-meta-data-name')
  var fieldMDValue = button.getAttribute('data-bs-meta-data-value')
  var fieldMDUnit = button.getAttribute('data-bs-meta-data-units')
  var fieldObjectPath = button.getAttribute('data-bs-data-path')
  // If necessary, you could initiate an AJAX request here
  // and then do the updating in a callback.
  //
  // Update the modal's content.
  //var modalTitle = editMetaData.querySelector('.modal-title')
  var modalBodyInputMDName = editMetaData.querySelector('#meta-data-name')
  var modalBodyInputMDValue = editMetaData.querySelector('#meta-data-value')
  var modalBodyInputMDUnit = editMetaData.querySelector('#meta-data-units')
  var modalBodyInputDataPath = editMetaData.querySelector('#object-path')

  var modalBodyInputOrigMDName = editMetaData.querySelector('#orig-meta-data-name')
  var modalBodyInputOrigMDValue = editMetaData.querySelector('#orig-meta-data-value')
  var modalBodyInputOrigMDUnit = editMetaData.querySelector('#orig-meta-data-units')


  //modalTitle.textContent = 'Data object ' +
  modalBodyInputMDName.value = fieldMDName
  modalBodyInputMDValue.value = fieldMDValue
  modalBodyInputMDUnit.value = fieldMDUnit
  modalBodyInputDataPath = fieldObjectPath

  modalBodyInputOrigMDName.value = fieldMDName
  modalBodyInputOrigMDValue.value = fieldMDValue
  modalBodyInputOrigMDUnit.value = fieldMDUnit

})

//// Delete meta data listener for modal

var deleteMetaData = document.getElementById('deleteMetaData')
deleteMetaData.addEventListener('show.bs.modal', function (event) {
  // Button that triggered the modal
  var button = event.relatedTarget
  // Extract info from data-bs-* attributes
  var fieldMDName = button.getAttribute('data-bs-meta-data-name')
  var fieldMDValue = button.getAttribute('data-bs-meta-data-value')
  var fieldMDUnit = button.getAttribute('data-bs-meta-data-units')
  var fieldObjectPath = button.getAttribute('data-bs-data-path')
  // If necessary, you could initiate an AJAX request here
  // and then do the updating in a callback.
  //
  // Update the modal's content.
  var modalTitle = deleteMetaData.querySelector('.modal-title')
  var modalBodyInputMDName = deleteMetaData.querySelector('#meta-data-name-delete')
  var modalBodyInputMDValue = deleteMetaData.querySelector('#meta-data-value-delete')
  var modalBodyInputMDUnit = deleteMetaData.querySelector('#meta-data-units-delete')
  var modalBodyInputDataPath = deleteMetaData.querySelector('#object-path-delete')


  //modalTitle.textContent = 'Data object ' +
  modalBodyInputMDName.value = fieldMDName
  modalBodyInputMDValue.value = fieldMDValue
  modalBodyInputMDUnit.value = fieldMDUnit
  modalBodyInputDataPath = fieldObjectPath

})
  </script>
{% endblock javascript %}
